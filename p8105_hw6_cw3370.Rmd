---
title: "p8105_hw6_cw3370.Rmd"
output: 
  github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(knitr)
library(modelr)
```

# Problem 1
Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).
```{r message=FALSE}
birthweight_df <- read_csv("data/birthweight.csv") %>% 
  mutate(
    babysex = factor(babysex,
                     levels = c(1,2),
                     labels = c("male","female")),
    frace = factor(frace,
                   levels = c(1,2,3,4,8,9),
                   labels = c("White","Black","Asian","Puerto Rican","Other","Unkown")),
    malform = factor(malform,
                     levels = c(0,1),
                     labels = c("absense","present")),
    mrace = factor(mrace,
               levels = c(1,2,3,4,8),
               labels = c("White","Black","Asian","Puerto Rican","Other"))
) %>% 
  drop_na()

```

Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values â€“ use add_predictions and add_residuals in making this plot.

based on knowledge for the factors that underly birthweight, l choose several factors, including:babysex, bhead,blength,frace,gaweeks,malform,mrace,ppwt,wtgain,smoken and then l make  plots and conduct SLR of birthweight versus each factor to see whether there are potential relationship(checking plot and R^2).Finally l choose bhead,blength,gaweeks,which R_squared are bigger than 0.1.

```{r echo=FALSE}
lm(bwt ~ parity, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared)

test <- 
tibble(
  variable = c("babysex","bhead","blength","frace","gaweeks","malform","mrace","ppwt","wtgain","smoken"),
  R_squared = c(
lm(bwt ~ babysex, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ bhead, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ blength, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ frace, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ gaweeks, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ malform, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ mrace, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ ppwt, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ wtgain, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared),
lm(bwt ~ smoken, data = birthweight_df) %>% 
   broom::glance() %>% 
   pull(r.squared)))

knitr::kable(test)
```

```{r}
fit <- lm(bwt ~ bhead + blength +gaweeks, data =birthweight_df)

birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  modelr::add_predictions(fit) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Plot of Model Residuals against Fitted Values", 
    x = "Fitted Values",
    y = "Residuals"
  ) 

```


```{r}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>% 
  mutate(
    my_mod         = map(train, ~lm(bwt ~ bhead + blength + gaweeks, data = .x)),
    bl_ga_mod      = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    bh_bl_sex_mod  = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = .x)) 
    ) %>% 
  mutate(
    rmse_my        = map2_dbl(my_mod        , test, ~rmse(model = .x, data = .y)),
    rmse_bl_ga     = map2_dbl(bl_ga_mod     , test, ~rmse(model = .x, data = .y)),
    rmse_bh_bl_sex = map2_dbl(bh_bl_sex_mod , test, ~rmse(model = .x, data = .y))
    )

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

